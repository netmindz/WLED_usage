<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WLED Usage Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        #chart {
            margin: 20px 0;
        }
        
        .bar {
            fill: #4CAF50;
            transition: fill 0.3s;
        }
        
        .bar:hover {
            fill: #45a049;
        }
        
        .bar-label {
            font-size: 12px;
            fill: #333;
        }
        
        .axis-label {
            font-size: 14px;
            fill: #333;
        }
        
        .axis path,
        .axis line {
            stroke: #ccc;
        }
        
        .axis text {
            font-size: 12px;
            fill: #666;
        }
        
        .error {
            color: #d32f2f;
            text-align: center;
            padding: 20px;
            background-color: #ffebee;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .stats-summary {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .stat-box {
            text-align: center;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 4px;
            min-width: 150px;
            margin: 10px;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .tooltip {
            position: absolute;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WLED Usage Dashboard</h1>
        <p class="subtitle">Device Distribution by Country</p>
        
        <div id="stats-summary" class="stats-summary"></div>
        <div id="loading" class="loading">Loading data...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="chart"></div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        // Configuration
        const margin = {top: 20, right: 30, bottom: 100, left: 60};
        const width = 1140 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;
        
        // Tooltip
        const tooltip = d3.select("#tooltip");
        
        // Fetch data from API
        fetch('/api/stats/country')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                
                if (!data || data.length === 0) {
                    document.getElementById('error').textContent = 'No data available';
                    document.getElementById('error').style.display = 'block';
                    return;
                }
                
                // Display summary statistics
                displayStats(data);
                
                // Create visualization
                createBarChart(data);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent = 'Error loading data: ' + error.message;
                document.getElementById('error').style.display = 'block';
            });
        
        function displayStats(data) {
            const totalDevices = data.reduce((sum, d) => sum + d.count, 0);
            const totalCountries = data.length;
            const topCountry = data[0];
            
            const statsHtml = `
                <div class="stat-box">
                    <div class="stat-number">${totalDevices.toLocaleString()}</div>
                    <div class="stat-label">Total Devices</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${totalCountries}</div>
                    <div class="stat-label">Countries</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${topCountry.countryCode}</div>
                    <div class="stat-label">Top Country (${topCountry.count.toLocaleString()} devices)</div>
                </div>
            `;
            
            document.getElementById('stats-summary').innerHTML = statsHtml;
        }
        
        function createBarChart(data) {
            // Limit to top 20 countries for better visualization
            const topData = data.slice(0, 20);
            
            // Create SVG
            const svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            // X scale
            const x = d3.scaleBand()
                .range([0, width])
                .domain(topData.map(d => d.countryCode))
                .padding(0.2);
            
            // Y scale
            const y = d3.scaleLinear()
                .domain([0, d3.max(topData, d => d.count)])
                .range([height, 0]);
            
            // X axis
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");
            
            // Y axis
            svg.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(y).ticks(10));
            
            // Y axis label
            svg.append("text")
                .attr("class", "axis-label")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Number of Devices");
            
            // X axis label
            svg.append("text")
                .attr("class", "axis-label")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .style("text-anchor", "middle")
                .text("Country Code");
            
            // Bars
            svg.selectAll(".bar")
                .data(topData)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.countryCode))
                .attr("width", x.bandwidth())
                .attr("y", height)
                .attr("height", 0)
                .on("mouseover", function(event, d) {
                    tooltip.style("opacity", 1)
                        .html(`<strong>${d.countryCode}</strong><br/>Devices: ${d.count.toLocaleString()}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                })
                .transition()
                .duration(800)
                .attr("y", d => y(d.count))
                .attr("height", d => height - y(d.count));
            
            // Add value labels on top of bars
            svg.selectAll(".bar-label")
                .data(topData)
                .enter()
                .append("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d.countryCode) + x.bandwidth() / 2)
                .attr("y", d => y(d.count) - 5)
                .attr("text-anchor", "middle")
                .style("opacity", 0)
                .text(d => d.count.toLocaleString())
                .transition()
                .delay(800)
                .duration(400)
                .style("opacity", 1);
        }
    </script>
</body>
</html>
